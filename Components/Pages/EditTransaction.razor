@page "/edittransaction/{TransactionId:int}"
@layout MainLayout
@rendermode InteractiveServer

@using GoalGrower.Data
@using GoalGrower.Models
@using Microsoft.EntityFrameworkCore
@inject NavigationManager Navigation

@inject AppDbContext _context

<PageTitle>Goal Grower - Edit Transaction Page</PageTitle>


@if (transaction == null)
{
    <p>Loading...</p>
}
else
    {
    <h1>Edit Transaction</h1>

    <EditForm FormName="EditTransactionForm" Model="transaction" OnValidSubmit="HandleEditTransaction">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div>
            <label>Date</label>
            <InputDate class="form-input" id="TransactionDate" @bind-Value="transaction.TransactionDate" />
        </div>
        <div>
            <label>Description</label>
            <InputText class="form-input" id="TransactionDescription" @bind-Value="transaction.TransactionDescription" placeholder="Description" />
        </div>
        <div>
            <label>Type</label>
            <InputRadioGroup class="form-input" id="TransactionType" @bind-Value="transaction.TransactionType">
                <label class="radio-inline">
                    <InputRadio Value="TransactionModel.TransactionTypeEnum.Deposit" /> Deposit
                </label>
                <label class="radio-inline">
                    <InputRadio Value="TransactionModel.TransactionTypeEnum.Withdrawal" /> Withdrawal
                </label>
            </InputRadioGroup>
        </div>
        <div>
            <label>Amount</label>
            <InputNumber class="form-input" id="TransactionAmount" @bind-Value="transaction.TransactionAmount" />
        </div>

        <div class="form-button-options">
            <button type="submit">Save Changes</button>
            <a class="cancel-button" href="/transactiondetails/@TransactionId">Cancel</a>
        </div>
    </EditForm>
}
@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}


@code {
    [Parameter]
    public int TransactionId { get; set; }
    private TransactionModel? transaction;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            transaction = await _context.Transactions
            .Include(t => t.Goal)
            .FirstOrDefaultAsync(t => t.TransactionId == TransactionId);

            if (transaction == null)
            {
                errorMessage = "Transaction not found.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading transaction: " + ex.Message;
        }
    }

    private async Task HandleEditTransaction()
    {
        errorMessage = string.Empty;
        try
        {
            _context.Transactions.Update(transaction!);
            await _context.SaveChangesAsync();

            // Redirect back to the goal details page
            Navigation.NavigateTo($"/goaldetails/{transaction!.GoalId}");
        }
        catch (Exception ex)
        {
            errorMessage = "Error saving transaction: " + ex.Message;
        }
    }
}