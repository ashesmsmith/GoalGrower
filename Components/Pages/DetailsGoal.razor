@page "/goaldetails/{GoalId:int}"
@layout MainLayout

@using GoalGrower.Data
@using GoalGrower.Models
@using Microsoft.EntityFrameworkCore

@inject AppDbContext _context

<PageTitle>Goal Grower - Goal Details Page</PageTitle>

<h1>@goal.GoalName Details</h1>

<div class="details-container">
    <div class="detail">
        <p>Description:</p>
        <p>@goal.GoalDescription</p>
    </div>
    <div class="detail">
        <p>Goal Amount:</p>
        <p>@goal.GoalAmount</p>
    </div>
    <div class="detail">
        <p>Complete By Date:</p>
        <p>@goal.CompletionDate</p>
    </div>

    <div class="icon-container">
        <a href="/editgoal/@goal.GoalId">
            <img src="/images/edit-icon.png" alt="edit icon" class="icon" />
        </a>
        <a href="/deletegoal/@goal.GoalId">
            <img src="/images/delete-icon.png" alt="delete icon" class="icon" />
        </a>
    </div>
</div>

<h2>Transactions</h2>
<button type="submit" @onclick="AddTransaction">Add Transaction</button>

<div class="transactions-container">
    @if (transactions != null && transactions.Any())
    {
        <ul class="transaction-list">
            @foreach (var transaction in transactions)
            {
                <li>
                    <span>
                        @transaction.TransactionDate.ToString("yyyy-MM-dd") |
                        @transaction.TransactionType |
                        @transaction.TransactionAmount
                    </span>
                    <div>
                        <a href="edittransaction/@transaction.TransactionId">
                            <img src="/images/edit-icon.png" alt="edit icon" class="sm-icon" />
                        </a>
                        <a href="/deletetransaction/@transaction.TransactionId">
                            <img src="/images/delete-icon.png" alt="delete icon" class="sm-icon" />
                        </a>
                    </div>
                </li>
            }
        </ul>
    }
    else
    {
        <p>Nothing here yet!</p>
    }
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}

@code {
    [Parameter]
    public int GoalId { get; set; }

    private GoalModel? goal;
    private List<TransactionModel> transactions = new List<TransactionModel>();
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {

        try
        {
            goal = await _context.Goals
            .Include(g => g.Transactions)
            .FirstOrDefaultAsync(g => g.GoalId == GoalId);

            if (goal == null)
            {
                errorMessage = "Goal not found.";
                return;
            }

            transactions = goal.Transactions ?? new List<TransactionModel>();
        }
        catch (Exception ex)
        {
            errorMessage = "Error loading goal: " + ex.Message;
        }
    }

    private void AddTransaction()
    {
        // Navigate, open modal, etc.
    }
}