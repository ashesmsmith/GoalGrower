@page "/deletegoal/{GoalId:int}"
@layout MainLayout

@using GoalGrower.Data
@using GoalGrower.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore

@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<UserModel> UserManager
@inject AppDbContext Db
@inject NavigationManager Nav

<PageTitle>Goal Grower - Delete Goal</PageTitle>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}
else if (goal == null)
{
    <p>Loading goal...</p>
}
else
{
    <h1>Delete Goal</h1>
    <h2>@goal.GoalName</h2>

    <div class="details-container">
        <div class="detail">
            <p>Description:</p>
            <p>@goal.GoalDescription</p>
        </div>

        <div class="detail">
            <p>Goal Amount:</p>
            <p>@goal.GoalAmount.ToString("C")</p>
        </div>

        <div class="detail">
            <p>Complete By Date:</p>
            <p>@goal.CompletionDate.ToShortDateString()</p>
        </div>
    </div>

    <div class="form-button-options">
        <button @onclick="HandleDeleteGoal" class="delete-btn">Confirm Delete</button>
        <a class="cancel-button" href="/goaldetails/@GoalId">Cancel</a>
    </div>
}

@code {
    [Parameter]
    public int GoalId { get; set; }

    private GoalModel? goal;
    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Validate authentication
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (!user.Identity?.IsAuthenticated ?? false)
            {
                errorMessage = "You must be logged in to delete a goal.";
                return;
            }

            var userId = UserManager.GetUserId(user);

            // Secure query â€” user must own the goal
            goal = await Db.Goals
            .FirstOrDefaultAsync(g => g.GoalId == GoalId && g.UserId == userId);

            if (goal == null)
            {
                errorMessage = "Goal not found or you do not have permission to delete it.";
                return;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading goal: {ex.Message}";
        }
    }

    private async Task HandleDeleteGoal()
    {
        if (goal == null)
        {
            errorMessage = "Goal not loaded.";
            return;
        }

        try
        {
            Db.Goals.Remove(goal);
            await Db.SaveChangesAsync();

            Nav.NavigateTo("/dashboard");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting goal: {ex.Message}";
        }
    }
}