@page "/register"
@layout NoNavLayout
@using GoalGrower.Models
@using Microsoft.AspNetCore.Identity
@inject UserManager<User> UserManager
@inject SignInManager<User> SignInManager
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>Goal Grower Register</PageTitle>

<img src="images\logo.png" alt="Goal Grower Logo" width="500" height="500" class="logo" />
<h1>Register</h1>

<EditForm FormName="RegisterForm" Model="registerModel" OnValidSubmit="HandleRegister">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <InputText id="Name" @bind-Value="registerModel.Name" placeholder="First Name" />
    <InputText id="LastName" @bind-Value="registerModel.LastName" placeholder="Last Name" />
    <InputText id="Email" @bind-Value="registerModel.Email" type="email" placeholder="Email Address" />
    <InputText id="Password" @bind-Value="registerModel.Password" type="password" placeholder="Password" />
    <InputText id="ConfirmPassword" @bind-Value="registerModel.ConfirmPassword" type="password"
        placeholder="Confirm Password" />

    <button type="submit">Register</button>
</EditForm>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p>
}

@code {
    private RegisterModel registerModel { get; set; } = new RegisterModel();
    private string errorMessage = string.Empty;

    private async Task HandleRegister()
    {
        errorMessage = string.Empty;

        var user = new User
        {
            UserName = registerModel.Email,
            Email = registerModel.Email,
            Name = registerModel.Name,
            LastName = registerModel.LastName,
            BankAmount = 0
        };

        var result = await UserManager.CreateAsync(user, registerModel.Password);

        if (result.Succeeded)
        {
            // Sign in the user
            await SignInManager.SignInAsync(user, isPersistent: false);

            // Let Blazor finish the current render cycle before redirecting
            await Task.Yield();

            // Now redirect to dashboard
            Navigation.NavigateTo("/dashboard");
        }
        else
        {
            errorMessage = string.Join(" | ", result.Errors.Select(e => e.Description));
        }
    }

}